# Excel MCP Server 调用指南

本文档详细说明如何正确调用 Excel MCP Server 的工具，包括 Python 和 curl 两种实现方式。

## 🔍 问题分析

原始的 curl 命令无法正常工作，原因是：

1. **缺少正确的 MCP 协议流程**：需要先初始化会话并获取 session ID
2. **缺少 JSON-RPC 格式**：工具调用必须使用标准的 JSON-RPC 2.0 格式
3. **缺少会话管理**：需要在后续请求中携带 session ID

## 📝 正确的调用流程

### 第一步：初始化会话

```bash
curl -X POST http://localhost:8000/mcp \
  -H "Content-Type: application/json" \
  -H "Accept: application/json,text/event-stream" \
  -D /tmp/headers.txt \
  -d '{
    "jsonrpc": "2.0",
    "id": 1,
    "method": "initialize",
    "params": {
      "protocolVersion": "2024-11-05",
      "capabilities": {
        "roots": {"listChanged": true},
        "sampling": {}
      },
      "clientInfo": {
        "name": "curl-client",
        "version": "1.0.0"
      }
    }
  }'
```

**重要**：从响应头中提取 `mcp-session-id`：

```bash
SESSION_ID=$(grep -i "mcp-session-id:" /tmp/headers.txt | cut -d' ' -f2 | tr -d '\r\n')
```

### 第二步：发送初始化完成通知

```bash
curl -X POST http://localhost:8000/mcp \
  -H "Content-Type: application/json" \
  -H "Accept: application/json,text/event-stream" \
  -H "mcp-session-id: $SESSION_ID" \
  -d '{
    "jsonrpc": "2.0",
    "method": "notifications/initialized"
  }'
```

### 第三步：调用工具

```bash
curl -X POST http://localhost:8000/mcp \
  -H "Content-Type: application/json" \
  -H "Accept: application/json,text/event-stream" \
  -H "mcp-session-id: $SESSION_ID" \
  -d '{
    "jsonrpc": "2.0",
    "id": 3,
    "method": "tools/call",
    "params": {
      "name": "read_data_from_excel",
      "arguments": {
        "filepath": "/Users/nashzhou/code/openhands/excel-mcp-server/small.xlsx",
        "sheet_name": "Sheet",
        "start_cell": "A1"
      }
    }
  }'
```

## 🐍 Python 实现

我们提供了一个完整的 Python 客户端类 `ExcelMCPClient`，它封装了所有必要的协议细节：

```python
from excel_mcp_client import ExcelMCPClient

# 创建客户端并连接
client = ExcelMCPClient()
if client.connect():
    # 读取 Excel 数据
    data = client.read_excel_data(
        filepath="/path/to/your/file.xlsx",
        sheet_name="Sheet1",
        start_cell="A1"
    )
    print(data)
```

### 主要特性

- ✅ 自动处理会话管理
- ✅ 支持所有 Excel MCP 工具
- ✅ 错误处理和重试逻辑
- ✅ 类型提示和文档
- ✅ 便捷方法封装

## 📁 提供的文件

1. **`excel_mcp_client.py`** - 完整的 Python 客户端实现
2. **`curl_example.sh`** - 完整的 curl 调用示例脚本
3. **`full_mcp_test.py`** - 协议流程测试脚本

## 🔧 可用的工具方法

Excel MCP Server 提供了 25 个工具，主要包括：

### 数据操作

- `read_data_from_excel` - 读取 Excel 数据
- `write_data_to_excel` - 写入 Excel 数据

### 工作簿操作

- `create_workbook` - 创建新工作簿
- `get_workbook_metadata` - 获取工作簿元数据

### 工作表操作

- `create_worksheet` - 创建工作表
- `copy_worksheet` - 复制工作表
- `delete_worksheet` - 删除工作表
- `rename_worksheet` - 重命名工作表

### 格式化操作

- `format_range` - 格式化单元格范围
- `merge_cells` - 合并单元格
- `unmerge_cells` - 取消合并单元格

### 公式操作

- `apply_formula` - 应用 Excel 公式
- `validate_formula_syntax` - 验证公式语法

### 图表和透视表

- `create_chart` - 创建图表
- `create_pivot_table` - 创建透视表
- `create_table` - 创建 Excel 表格

## 🚀 快速开始

1. **启动服务器**：

   ```bash
   uvx excel-mcp-server streamable-http
   ```

2. **使用 Python 客户端**：

   ```bash
   python excel_mcp_client.py
   ```

3. **使用 curl 脚本**：

   ```bash
   ./curl_example.sh
   ```

## ⚠️ 注意事项

1. **文件路径**：在 streamable-http 模式下，必须使用绝对路径
2. **会话管理**：每次调用都需要携带正确的 session ID
3. **响应格式**：服务器返回 SSE 格式的响应，需要正确解析
4. **错误处理**：注意检查 JSON-RPC 响应中的错误字段

## 📊 示例输出

成功调用后，您将获得如下格式的 Excel 数据：

```json
{
  "range": "A1:B4",
  "sheet_name": "Sheet",
  "cells": [
    {
      "address": "A1",
      "value": "Name",
      "row": 1,
      "column": 1,
      "validation": {
        "has_validation": false
      }
    },
    // ... 更多单元格数据
  ]
}
```

现在您已经有了完整的解决方案来正确调用 Excel MCP Server！
