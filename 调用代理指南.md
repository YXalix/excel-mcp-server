# Excel MCP 代理服务器使用指南

本文档提供了如何使用 Excel MCP 代理服务器的详细中文指南。代理服务器模式支持将客户端请求路由到动态创建的 stdio 子进程，实现更好的隔离性和可扩展性。

## 基本概念

Excel MCP 代理服务器采用了一种新的架构，将原来的单一服务器模式升级为更加灵活的代理架构：

1. **代理服务器**：一个 HTTP/WebSocket 服务器，负责接收客户端请求
2. **子进程池**：为每个客户端会话动态创建和管理独立的 stdio 子进程
3. **会话隔离**：不同客户端之间的状态完全隔离，互不影响
4. **资源管理**：自动回收闲置会话资源，优化系统性能

这种架构具有以下优势：

- **隔离性**：每个客户端有独立的执行环境，避免状态混淆
- **可靠性**：单个客户端的错误不会影响其他客户端
- **可扩展性**：可以处理更多并发客户端请求
- **兼容性**：与现有 MCP 客户端完全兼容

## 启动代理服务器

可以通过以下命令启动代理服务器：

```bash
# 使用默认配置启动
uvx excel-mcp-server proxy

# 指定端口和主机
FASTMCP_PORT=9000 FASTMCP_HOST=127.0.0.1 uvx excel-mcp-server proxy

# 指定 Excel 文件存储路径
EXCEL_FILES_PATH=/path/to/excel/files uvx excel-mcp-server proxy
```

## 环境变量

代理服务器支持以下环境变量：

| 环境变量 | 说明 | 默认值 |
| --- | --- | --- |
| FASTMCP_HOST | 服务器监听的主机地址 | 0.0.0.0 |
| FASTMCP_PORT | 服务器监听的端口 | 8017 |
| EXCEL_FILES_PATH | Excel 文件存储路径 | 系统临时目录下的 excel_mcp_files 文件夹 |

## 客户端连接

### 1. 使用 MCP 客户端配置

客户端可以使用标准的 MCP 客户端配置连接到代理服务器：

```json
{
   "mcpServers": {
      "excel": {
         "url": "http://localhost:8017/mcp"
      }
   }
}
```

### 2. 使用 cURL 发送请求

```bash
curl -X POST http://localhost:8017/mcp \
  -H "Content-Type: application/json" \
  -H "X-Session-ID: your-session-id" \
  -d '{
    "jsonrpc": "2.0",
    "id": 1,
    "method": "create_workbook",
    "params": {
      "filepath": "./example.xlsx"
    }
  }'
```

### 3. 使用 Python 客户端

您可以使用提供的 `proxy_client_example.py` 脚本作为客户端示例：

```bash
python proxy_client_example.py --url http://localhost:8017/mcp --file ./myworkbook.xlsx
```

## 会话管理

### 会话 ID

代理服务器使用会话 ID 来识别和管理客户端会话：

- **自动生成**：如果客户端未提供会话 ID，服务器会自动生成
- **显式指定**：客户端可以通过 `X-Session-ID` HTTP 头指定会话 ID
- **会话持久化**：使用相同会话 ID 的请求会被路由到同一个子进程

### 会话生命周期

1. **创建**：首次请求时创建新的子进程
2. **活动**：每次请求更新会话活动时间
3. **闲置**：默认 5 分钟无活动后，会话被标记为闲置
4. **清理**：闲置会话会被自动清理，释放系统资源

## 高级功能

### 会话隔离

每个会话都有完全独立的执行环境，包括：

- 独立的内存空间
- 独立的文件访问状态
- 独立的异常处理

这确保了一个客户端的操作不会影响其他客户端。

### 流式处理

对于需要流式返回结果的场景，可以使用流式 HTTP 端点：

```bash
curl -X POST http://localhost:8017/stream/mcp \
  -H "Content-Type: application/json" \
  -H "X-Session-ID: your-session-id" \
  -d '{
    "jsonrpc": "2.0",
    "id": 1,
    "method": "read_data_from_excel",
    "params": {
      "filepath": "./large.xlsx",
      "sheet_name": "Data"
    }
  }'
```

### WebSocket 支持

对于需要保持长连接的场景，可以使用 WebSocket 连接：

```javascript
const ws = new WebSocket('ws://localhost:8017/ws/mcp');

ws.onopen = () => {
  // 发送请求
  ws.send(JSON.stringify({
    jsonrpc: "2.0",
    id: 1,
    method: "create_workbook",
    params: {
      filepath: "./example.xlsx"
    }
  }));
};

ws.onmessage = (event) => {
  // 处理响应
  console.log(JSON.parse(event.data));
};
```

## 性能优化

### 调整闲置超时时间

如果您的应用程序有特定的会话生命周期需求，可以修改代码中的 `idle_timeout` 参数调整闲置会话的超时时间。

### 增加系统限制

对于高并发场景，建议增加系统的文件描述符限制：

```bash
# 临时设置
ulimit -n 4096

# 永久设置（需要编辑系统配置文件）
echo "* soft nofile 4096" >> /etc/security/limits.conf
echo "* hard nofile 4096" >> /etc/security/limits.conf
```

## 故障排除

### 常见问题

1. **连接被拒绝**：检查代理服务器是否正在运行，以及端口是否正确
2. **请求超时**：可能是子进程处理时间过长，考虑增加客户端超时设置
3. **内存占用高**：检查是否有大量闲置会话未被清理，考虑减少闲置超时时间

### 日志分析

代理服务器日志位于 `excel-mcp-proxy.log` 文件中，包含以下信息：

- 服务器启动和关闭事件
- 会话创建和清理事件
- 请求处理错误
- 子进程异常

### 调试模式

如果需要更详细的日志，可以修改代码中的日志级别：

```python
logging.basicConfig(
    level=logging.DEBUG,  # 改为 DEBUG 级别
    ...
)
```

## 安全考虑

### 文件访问限制

代理服务器默认将所有 Excel 文件限制在 `EXCEL_FILES_PATH` 目录下，防止对系统其他文件的访问。

### 会话隔离

不同会话之间完全隔离，防止一个客户端访问其他客户端的数据。

### 资源限制

自动清理闲置会话，防止资源耗尽攻击。

## 结语

Excel MCP 代理服务器提供了一种更加灵活、可靠和可扩展的方式来处理 Excel 操作请求。通过动态创建和管理子进程，它实现了更好的隔离性和性能，同时保持与现有 MCP 客户端的完全兼容性。
